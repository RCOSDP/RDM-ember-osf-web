/*
--------------------------------------------------------
suggest.js - Input Suggest
Version 2.2 (Update 2010/09/14)

Copyright (c) 2006-2010 onozaty (http://www.enjoyxstudy.com)

Released under an MIT-style license.

For details, see the web site:
 http://www.enjoyxstudy.com/javascript/suggest/

--------------------------------------------------------
*/
if (!Suggest) {
  var Suggest = {};
}

function start(){

/*-- KeyCodes -----------------------------------------*/
Suggest.Key = {
  TAB:     9,
  RETURN: 13,
  ESC:    27,
  UP:     38,
  DOWN:   40
};

/*-- Utils --------------------------------------------*/
Suggest.copyProperties = function(dest, src) {
  for (var property in src) {
    dest[property] = src[property];
  }
  return dest;
};

/*-- Suggest.Local ------------------------------------*/
Suggest.Local = function() {
  this.initialize.apply(this, arguments);
};
Suggest.Local.prototype = {
  initialize: function(input, suggestArea, animateArea, scrollArea, candidateList, favoriteList, hintList,
                       dnupImgElm, geolocationImgElm, selectElm, mapElm, clearElm, initDisp, dispDefault, 
                       dnImgURL, upImgURL, geoOffImgURL, geoOnImgURL, favoriteIdpGroup, hintIdpGroup, embeddedFlg, optionElm) {

    this.input = this._getElement(input);
    this.suggestArea = this._getElement(suggestArea);
    this.animateArea = this._getElement(animateArea);
    this.scrollArea = this._getElement(scrollArea);
    this.candidateList = candidateList;
    this.favoriteList = favoriteList;
    this.hintList = hintList;
    this.dnupImgElm = this._getElement(dnupImgElm);
    this.geolocationImgElm = this._getElement(geolocationImgElm);
    this.selectElm = this._getElement(selectElm);
    this.mapElm = this._getElement(mapElm);
    this.clearElm = this._getElement(clearElm);
    this.initDisp = initDisp;
    this.dispDefault = dispDefault;
    this.dnImgURL = dnImgURL;
    this.upImgURL = upImgURL;
    this.geoOffImgURL = geoOffImgURL;
    this.geoOnImgURL = geoOnImgURL;
    this.favoriteIdpGroup = favoriteIdpGroup;
    this.hintIdpGroup = hintIdpGroup;
    this.embeddedFlg = embeddedFlg;
    this.setInputText(dispidp);
    this.oldText = (this.initDisp == this.getInputText()) ?
      '': this.getInputText();
    this.searchFlg = false;
    this.noMatch = true;
    this.userAgentFlg = 0;
    this.optionElm = this._getElement(optionElm);

    if (this.candidateList.length > 0) {
      // favorite IdP List
      if (this.favoriteList.length > 0) {
        this.candidateList = this.favoriteList.concat(this.candidateList);
      }
      // hint(IP, Domain) IdP List
      if (this.hintList.length > 0) {
        this.candidateList = this.hintList.concat(this.candidateList);
      }
    }
    if (!discofeed_flg){
      this.candidateList = new Array();
    }
    if (this.candidateList.length == 0) {
      this.setInputText(this.initDisp);
    }

    if (arguments[22]) this.setOptions(arguments[22]);

    // reg event
    this._addEvent(this.input, 'focus', this._bind(this.tabFocus));
    this._addEvent(this.input, 'blur', this._bind(this.tabBlur));

    var keyevent = 'keydown';
    if (window.opera || (navigator.userAgent.indexOf('Gecko') >= 0 && navigator.userAgent.indexOf('KHTML') == -1)) {
      keyevent = 'keypress';
    }
    this._addEvent(this.input, keyevent, this._bindEvent(this.keyEvent));
    this._addEvent(this.dnupImgElm, keyevent, this._bindEvent(this.keyEvent));
    this._addEvent(this.geolocationImgElm, keyevent, this._bindEvent(this.keyEvent));
    this._addEvent(this.mapElm, keyevent, this._bindEvent(this.keyEvent));
    this._addEvent(this.clearElm, keyevent, this._bindEvent(this.keyEvent));
    this._addEvent(this.dnupImgElm, 'click', this._bindEvent(this.elementClick));
    this._addEvent(this.geolocationImgElm, 'click', this._bindEvent(this.elementClick));
    this._addEvent(this.mapElm, 'click', this._bindEvent(this.elementClick));
    this._addEvent(this.clearElm, 'click', this._bindEvent(this.elementClick));
    this._addEvent(this.optionElm, 'click', this._bindEvent(this.elementClick, 'optionElm'));

    // init
    this.clearSuggestArea();
    $('#' + this.animateArea.id).hide();
    this.checkUserAgent();
    this.checkNoMatch(this.oldText);
    if (this.userAgentFlg == 1){
      this.touchScroll();
    }

    this.geolocationImgElm.src = this.geoOffImgURL;

  },

  // options
  interval: 500,
  dispMax: 20,
  listTagName: 'div',
  prefix: false,
  ignoreCase: true,
  highlight: false,
  dispAllKey: false,
  classMouseOver: 'wayf_over',
  classSelect: 'wayf_select',
  classDefault: 'wayf_default',
  classActive: 'wayf_active',
  classGroup: 'wayf_list_group',
  classIdPNm: 'wayf_list_idp',
  classIdPRegURL: 'wayf_list_idp_regurl',
  classGroupFavorite: 'wayf_list_group_favorite',
  classIdPNmFavorite: 'wayf_list_idp_favorite',
  classGroupHint: 'wayf_list_group_hint',
  classIdPNmHint: 'wayf_list_idp_hint',
  dispListTime: 300,
  showgrp: true,
  hookBeforeSearch: function(){},

  setOptions: function(options) {
    Suggest.copyProperties(this, options);
  },

  checkUserAgent: function() {
    if (navigator.userAgent.indexOf('Android 2') > 0){
      this.userAgentFlg = 1;
    } else if (navigator.userAgent.indexOf('iPhone') > 0 ||
               navigator.userAgent.indexOf('iPad') > 0 ||
               navigator.userAgent.indexOf('iPod') > 0 ||
               navigator.userAgent.indexOf('Android') > 0) {
      this.userAgentFlg = 2;
    } else {
      this.userAgentFlg = 0;
    }
  },

  checkNoMatch: function(text) {
    var flg = true;
    var search_cnt = 0;
    var countHintList = 0;
    var countFavoriteList = 0;

    if (text != '') {
      for (var i=0; i<this.candidateList.length; i++){
        for (var j=0; j<this.candidateList[i].search.length; j++){
          if (text.toLowerCase() == this.candidateList[i].search[j].toLowerCase()) {
            flg = false;
            break;
          }
        }
        if (!flg) {
          break;
        }
      }
    }

    if (this.suggestList){
      for (var i=0; i<this.hintList.length; i++){
        if (this.isMatchKind(this.hintList[i]) && this.isMatchLocation(this.hintList[i])){
          countHintList++;
        }
      }
      for (var i=0; i<this.favoriteList.length; i++){
        if (this.isMatchKind(this.favoriteList[i]) && this.isMatchLocation(this.favoriteList[i])){
          countFavoriteList++;
        }
      }
      search_cnt = this.suggestList.length - countHintList - countFavoriteList;
    }
    if (search_cnt == 1) {
      this.setStyleActive(this.suggestList[countHintList + countFavoriteList]);
      hiddenKeyText = this.candidateList[this.suggestIndexList[countHintList + countFavoriteList]].name;
      this.activePosition = countHintList + countFavoriteList;
      flg = false;
    }

    this.noMatch = flg;
  },

  elementClick: function(event, optionflg) {
    if (optionflg == 'optionElm') {
      if (this.dnupImgElm.src == this.upImgURL) {
        this.search();
      }
    } else {
    var element = this._getEventElement(event);
    if (element.id == this.input.id) {
      this.execSearch();
    } else if (element.id == this.dnupImgElm.id) {
      if (this.dnupImgElm.src == this.dnImgURL) {
        if (this.getInputText() == this.initDisp) this.setInputText('');
        this.execSearch();
      } else {
        this.closeList();
      }
    } else if (element.id == this.geolocationImgElm.id) {
      if (this.geolocationImgElm.src == this.geoOffImgURL) {
        addGeoHintList();
      } else {
        delGeoHintList();
      }
    } else if (element.id == this.clearElm.id) {
      this.setInputText('');
      hiddenKeyText = '';
      refresh_flg = false;
      this.input.focus();
      this.search();
      if (this.userAgentFlg == 0) {
        this.scrollArea.scrollTop = 0;
      }
    } else if (element.id == this.mapElm.id) {
      displayMapIdP(false);
    }
    }
  },

  execSearch: function() {
    this.input.focus();
    if (!this.suggestList) {
      this.searchFlg = true;
      this.checkLoop();
    }
  },

  tabFocus: function() {
    if (!this.suggestList) {
      if (this.getInputText() == this.initDisp) this.setInputText('');
    }
  },

  tabBlur: function() {
    if (!this.suggestList) {
      if (this.getInputText() == '') this.setInputText(this.initDisp);
    }
  },

  closeList: function() {
    this.changeUnactive();
    this.oldText = (this.initDisp == this.getInputText()) ?
      '': this.getInputText();
    $('#' + this.animateArea.id).hide();

    if (this.timerId) clearTimeout(this.timerId);
    this.timerId = null;

    setTimeout(this._bind(this.clearSuggestArea), 100);
    if (document.activeElement.id != this.input.id && this.getInputText() == '')
        this.setInputText(this.initDisp);
  },

  checkLoop: function() {
    var text = this.getInputText();
    if (text == this.initDisp) {
      text = '';
    }

    this.noMatch = true;
    if (text != this.oldText || this.searchFlg) {
      hiddenKeyText = '';
      this.searchFlg = false;
      this.oldText = text;
      this.search();
    }

    if (this.timerId) clearTimeout(this.timerId);
    this.timerId = setTimeout(this._bind(this.checkLoop), this.interval);
  },

  search: function() {

    // init
    this.clearSuggestArea();

    var text = this.getInputText();

    if (text == null || text == this.initDisp) return;
    if ((!geolocation_flg || !refresh_flg ) && discofeed_flg){
      this.candidateList = json_idp_list;
      this.favoriteList = json_idp_favoritelist;
      this.hintList = json_idp_hintlist;
      if (this.candidateList.length > 0) {
        // favorite IdP List
        if (this.favoriteList.length > 0) {
          this.candidateList = this.favoriteList.concat(this.candidateList);
        }
        // hint(IP, Domain) IdP List
        if (this.hintList.length > 0) {
          this.candidateList = this.hintList.concat(this.candidateList);
        }
      }
      geolocation_flg = true;
      refresh_flg = true;
    }
    if (this.candidateList.length == 0) {
      this.setInputText(this.initDisp);
    }

    this.hookBeforeSearch(text);
    var resultList = this._search(text);
    if (resultList.length != 0) {
      this.createSuggestArea(resultList);
    } else {
      $('#' + this.animateArea.id).hide();
    }
    this.checkNoMatch(this.getInputText());
    this.selectElm.disabled = this.noMatch;
  },

  _search: function(text) {

    var resultList = [];
    var temp;
    var chkFlg;
    this.suggestIndexList = [];
    for (var i=0; i<this.candidateList.length; i++){
      if (this.isMatchKind(this.candidateList[i]) && this.isMatchLocation(this.candidateList[i])){
        if (this.embeddedFlg == false ||
              isAllowedType(this.candidateList[i].entityid,this.candidateList[i].categoryKey)){
          if (text == '' ||
               this.candidateList[i].categoryName == this.hintIdpGroup ||
               this.candidateList[i].categoryName == this.favoriteIdpGroup) {
            resultList.push(this.candidateList[i]);
            this.suggestIndexList.push(i);
          } else {
            for (var j=0; j<this.candidateList[i].search.length; j++){
              if (this.isMatch(this.candidateList[i].search[j], text) != null) {
                resultList.push(this.candidateList[i]);
                this.suggestIndexList.push(i);
                break;
              }
            }
          }
        }
      }
      if (this.dispMax != 0 && resultList.length >= this.dispMax) break;
    }
    return resultList;
  },

  isMatchKind: function(chkIdP) {
    var chkFlg = false;
    if (selkind == '' || selkind == 'all' || selkind == chkIdP.kind) {
      chkFlg = true;
    } else if (typeof chkIdP.kind != "undefined"){
      for (var i=0; i<chkIdP.kind.length; i++){
        if (selkind == chkIdP.kind[i]){
          chkFlg = true;
          break;
        }
      }
    }
    return chkFlg;
  },

  isMatchLocation: function(chkIdP) {
    var chkFlg = false;
    if (sellocation == '' || sellocation == 'all' || sellocation == chkIdP.type || (sellocation == 'others' && chkIdP.type == 'unknown')) {
      chkFlg = true;
    }
    return chkFlg;
  },

  isMatch: function(value, pattern) {

    if (value == null) return null;

    var pos = (this.ignoreCase) ?
      value.toLowerCase().indexOf(pattern.toLowerCase())
      : value.indexOf(pattern);

    if ((pos == -1) || (this.prefix && pos != 0)) return null;
    if (this.highlight) {
      return (this._escapeHTML(value.substr(0, pos)) + '<strong>' 
             + this._escapeHTML(value.substr(pos, pattern.length)) 
               + '</strong>' + this._escapeHTML(value.substr(pos + pattern.length)));
    } else {
      return this._escapeHTML(value);
    }
  },

  clearSuggestArea: function() {
    this.suggestArea.innerHTML = '';
    this.suggestList = null;
    this.suggestIndexList = null;
    this.activePosition = null;
    this.dnupImgElm.src = this.dnImgURL;
  },

  createSuggestArea: function(resultList) {

    this.suggestList = [];
    this.inputValueBackup = this.input.value;

    if (this.userAgentFlg == 1) {
      $('#' + this.scrollArea.id).flickable('disable');
    }
    var oldGroup = '';
    $('#' + this.suggestArea.id).css('width', '');
    for (var i=0; i<resultList.length; i++){
      if (this.showgrp && oldGroup != resultList[i].categoryName) {
        var element = document.createElement(this.listTagName);
        if (resultList[i].categoryName == this.hintIdpGroup) {
          element.className = this.classGroupHint;
          element.innerHTML = '&nbsp;' + this.hintIdpGroup;
        } else if (resultList[i].categoryName == this.favoriteIdpGroup) {
          element.className = this.classGroupFavorite;
          element.innerHTML = '&nbsp;' + this.favoriteIdpGroup;
        } else {
          element.className = this.classGroup;
          element.innerHTML = '&nbsp;' + resultList[i].categoryName;
        }
        this.suggestArea.appendChild(element);
        oldGroup = resultList[i].categoryName;
      }
        
      var element1 = document.createElement(this.listTagName);
      var element2 = document.createElement(this.listTagName);
      if (resultList[i].categoryName == this.hintIdpGroup) {
        element1.className = this.classIdPNmHint;
        element2.className = this.classIdPNmHint;
      } else if (resultList[i].categoryName == this.favoriteIdpGroup) {
        element1.className = this.classIdPNmFavorite;
        element2.className = this.classIdPNmFavorite;
      } else {
        element1.className = this.classIdPNm;
        element2.className = this.classIdPNm;
      }

      var logo = '';
      if (resultList[i].logoURL && resultList[i].logoURL != '') {
        logo = '&nbsp;<span style="vertical-align: middle; padding:0px; margin:0px;"><img src="' + resultList[i].logoURL + '" height="18"/></span>';
      }
     
      if (this.userAgentFlg == 0 || this.userAgentFlg == 2) {
        element1.innerHTML = resultList[i].name + logo;
      } else {
        element1.innerHTML = '<a onclick="">' + resultList[i].name + '</a>' + logo;
      }

      this.suggestArea.appendChild(element1);

      this._addEvent(element1, 'click', this._bindEvent(this.listClick, i));
      this._addEvent(element1, 'mouseover', this._bindEvent(this.listMouseOver, i));
      this._addEvent(element1, 'mouseout', this._bindEvent(this.listMouseOut, i));

      var regurl = '';
      if ((typeof wayf_sp_entityID != 'undefined') && (typeof wayf_return_url != 'undefined') && (resultList[i].registrationURL != '')) {
        element2.innerHTML = '<a href="javascript:void(0)" class="' + this.classIdPRegURL + '">' + reg_button + '</a>';
        this.suggestArea.appendChild(element2);
        this._addEvent(element2, 'click', this._bindEvent(this.listClick2, i));
      }

      this.suggestList.push(element1);
    }

    this.scrollArea.scrollTop = 0;
    this.dnupImgElm.src = this.upImgURL;
    $('#' + this.animateArea.id).slideDown(this.dispListTime);
    var scrollAreaWidth = this.scrollArea.clientWidth;
    var suggestAreaWidth = this.suggestArea.scrollWidth;
    if (scrollAreaWidth > suggestAreaWidth) {
      $('#' + this.suggestArea.id).css('width', scrollAreaWidth + 'px');
    } else {
      $('#' + this.suggestArea.id).css('width', suggestAreaWidth + 'px');
    }
    if (this.userAgentFlg == 1) {
      $('#' + this.scrollArea.id).flickable('enable');
      $('#' + this.scrollArea.id).flickable('disable');
      $('#' + this.scrollArea.id).flickable('enable');
    }
  },

  touchScroll: function() {
    $('#' + this.scrollArea.id).flickable({
      disabled: false,
      elasticConstant: 0.2,
      friction: 0.7
    });
  },

  getInputText: function() {
    return this.input.value;
  },

  setInputText: function(text) {
    this.input.value = text;
  },

  // key event
  keyEvent: function(event) {

    if (!this.timerId) {
      this.timerId = setTimeout(this._bind(this.checkLoop), this.interval);
    }

    if (this._getEventElement(event).id == this.dnupImgElm.id
        || this._getEventElement(event).id == this.clearElm.id) {
      if (event.keyCode == Suggest.Key.RETURN) {
        this._stopEvent(event);
        this.elementClick(event);
      }
    } else if (this.dispAllKey && event.ctrlKey 
        && this.getInputText() == ''
        && !this.suggestList
        && event.keyCode == Suggest.Key.DOWN) {
      // dispAll
      this._stopEvent(event);
      this.keyEventDispAll();
    } else if (event.keyCode == Suggest.Key.UP ||
               event.keyCode == Suggest.Key.DOWN) {
      // search
      if (!this.suggestList && event.keyCode == Suggest.Key.DOWN) {
        this.execSearch();
      }
      // key move
      if (this.suggestList && this.suggestList.length != 0) {
  hiddenKeyText = '';
        this._stopEvent(event);
        this.keyEventMove(event.keyCode);
      } 
    } else if (event.keyCode == Suggest.Key.RETURN) {
      // fix
      if (this.selectElm.disabled == true) {
        if (this.suggestList.length != 1) {
          this._stopEvent(event);
//          this.keyEventReturn();
        }
      }
    } else if (event.keyCode == Suggest.Key.ESC) {
      // clear
      this._stopEvent(event);
      setTimeout(this._bind(this.keyEventEsc), 5);
    } else if (event.keyCode == Suggest.Key.TAB) {
      if (this.getInputText() == '') this.setInputText(this.initDisp);
      if (this.suggestList) this.closeList();
    } else {
      this.keyEventOther(event);
    }
  },

  keyEventDispAll: function() {
    // init
    this.clearSuggestArea();

    this.oldText = this.getInputText();

    this.suggestIndexList = [];
    for (var i=0; i<this.candidateList.length; i++){
      this.suggestIndexList.push(i);
    }

    this.createSuggestArea(this.candidateList);
  },

  keyEventMove: function(keyCode) {

    this.changeUnactive();

    if (keyCode == Suggest.Key.UP) {
      // up
      if (this.activePosition == null) {
        this.activePosition = this.suggestList.length -1;
      }else{
        this.activePosition--;
        if (this.activePosition < 0) {
          this.activePosition = null;
          this.input.value = this.inputValueBackup;
          this.scrollArea.scrollTop = 0;
          return;
        }
      }
    }else{
      // down
      if (this.activePosition == null) {
        this.activePosition = 0;
      }else{
        this.activePosition++;
      }

      if (this.activePosition >= this.suggestList.length) {
        this.activePosition = null;
        this.input.value = this.inputValueBackup;
        this.scrollArea.scrollTop = 0;
        return;
      }
    }

    this.changeActive(this.activePosition);
  },

  keyEventReturn: function() {

    if (this.activePosition != null && this.activePosition >= 0) {
      this.selectElm.disabled = false;
    }
    this.clearSuggestArea();
    this.moveEnd();
  },

  keyEventEsc: function() {

    this.setInputText('');
    this.selectElm.disabled = true;
    hiddenKeyText = '';
    this.closeList();
  },

  keyEventOther: function(event) {},

  changeActive: function(index) {
    this.setStyleActive(this.suggestList[index]);
    this.setInputText(this.candidateList[this.suggestIndexList[index]].name);
    this.oldText = this.getInputText();
    this.input.focus();
    this.selectElm.disabled = false;
  },

  changeUnactive: function() {

    if (this.suggestList != null 
        && this.suggestList.length > 0
        && this.activePosition != null) {
      this.setStyleUnactive(this.suggestList[this.activePosition], this.activePosition);
    }
  },

  listClick: function(event, index) {

    this.closeList();
    this.changeUnactive();
    this.activePosition = index;
    this.changeActive(index);

    this.moveEnd();

    if (index != null && index >= 0) {
      this.selectElm.disabled = false;
    }
  },

  listClick2: function(event, index) {
    var regURL = this.candidateList[this.suggestIndexList[index]].registrationURL;
    var return_url = wayf_sp_samlDSURL + getGETArgumentSeparator(wayf_sp_samlDSURL);
    return_url += 'target=' + encodeURIComponent(wayf_return_url);
    return_url += '&amp;entityID=' + encodeURIComponent(this.candidateList[this.suggestIndexList[index]].entityid);
    regURL += '?entityID=' + encodeURIComponent(wayf_sp_entityID);
    regURL += '&amp;return=' + encodeURIComponent(return_url);
    location.href = regURL;
    
    this.closeList();
    this.changeUnactive();
    this.activePosition = index;
    this.changeActive(index);

    this.moveEnd();

    if (index != null && index >= 0) {
      this.selectElm.disabled = false;
    }
  },

  listMouseOver: function(event, index) {
    this.setStyleMouseOver(this._getEventElement(event));
  },

  listMouseOut: function(event, index) {

    if (!this.suggestList) return;

    var element = this._getEventElement(event);

    if (index == this.activePosition) {
      this.setStyleActive(element);
    }else{
      this.setStyleUnactive(element, index);
    }
  },

  setStyleActive: function(element) {
    element.className = this.classSelect;

    // auto scroll
    var offset = element.offsetTop;
    var offsetWithHeight = offset + element.clientHeight;

    if (this.scrollArea.scrollTop > offset) {
      this.scrollArea.scrollTop = offset
    } else if (this.scrollArea.scrollTop + this.scrollArea.clientHeight < offsetWithHeight) {
      this.scrollArea.scrollTop = offsetWithHeight - this.scrollArea.clientHeight;
    }
  },

  setStyleUnactive: function(element, index) {
    var countHintList = 0;
    var countFavoriteList = 0;
    for (var i=0; i<this.hintList.length; i++){
      if (this.isMatchKind(this.hintList[i]) && this.isMatchLocation(this.hintList[i])){
        countHintList++;
      }
    }
    for (var i=0; i<this.favoriteList.length; i++){
      if (this.isMatchKind(this.favoriteList[i]) && this.isMatchLocation(this.favoriteList[i])){
        countFavoriteList++;
      }
    }

    if (index < countHintList + countFavoriteList){
      if (countHintList > 0 && index < countHintList){
        element.className = this.classIdPNmHint;
      } else {
        element.className = this.classIdPNmFavorite;
      }
    } else {
      element.className = this.classIdPNm;
    }
  },

  setStyleMouseOver: function(element) {
    element.className = this.classMouseOver;
  },

  moveEnd: function() {

    if (this.input.createTextRange) {
      this.input.focus(); // Opera
      var range = this.input.createTextRange();
      range.move('character', this.input.value.length);
      range.select();
    } else if (this.input.setSelectionRange) {
      this.input.setSelectionRange(this.input.value.length, this.input.value.length);
    }
  },

  // Utils
  _getElement: function(element) {
    return (typeof element == 'string') ? document.getElementById(element) : element;
  },
  _addEvent: (window.addEventListener ?
    function(element, type, func) {
      element.addEventListener(type, func, false);
    } :
    function(element, type, func) {
      element.attachEvent('on' + type, func);
    }),
  _stopEvent: function(event) {
    if (event.preventDefault) {
      event.preventDefault();
      event.stopPropagation();
    } else {
      event.returnValue = false;
      event.cancelBubble = true;
    }
  },
  _getEventElement: function(event) {
    return event.target || event.srcElement;
  },
  _bind: function(func) {
    var self = this;
    var args = Array.prototype.slice.call(arguments, 1);
    return function(){ func.apply(self, args); };
  },
  _bindEvent: function(func) {
    var self = this;
    var args = Array.prototype.slice.call(arguments, 1);
    return function(event){ event = event || window.event; func.apply(self, [event].concat(args)); };
  },
  _escapeHTML: function(value) {
    return value.replace(/\&/g, '&amp;').replace( /</g, '&lt;').replace(/>/g, '&gt;')
             .replace(/\"/g, '&quot;').replace(/\'/g, '&#39;');
  }
};

/*-- Suggest.LocalMulti ---------------------------------*/
Suggest.LocalMulti = function() {
  this.initialize.apply(this, arguments);
};
Suggest.copyProperties(Suggest.LocalMulti.prototype, Suggest.Local.prototype);

Suggest.LocalMulti.prototype.delim = ' '; // delimiter

Suggest.LocalMulti.prototype.keyEventReturn = function() {

  this.clearSuggestArea();
  this.input.value += this.delim;
  this.moveEnd();
};

Suggest.LocalMulti.prototype.keyEventOther = function(event) {

  if (event.keyCode == Suggest.Key.TAB) {
    // fix
    if (this.suggestList && this.suggestList.length != 0) {
      this._stopEvent(event);

      if (!this.activePosition) {
        this.activePosition = 0;
        this.changeActive(this.activePosition);
      }

      this.clearSuggestArea();
      this.input.value += this.delim;
      if (window.opera) {
        setTimeout(this._bind(this.moveEnd), 5);
      } else {
        this.moveEnd();
      }
    }
  }
};

Suggest.LocalMulti.prototype.listClick = function(event, index) {

  this.changeUnactive();
  this.activePosition = index;
  this.changeActive(index);

  this.input.value += this.delim;
  this.moveEnd();
};

Suggest.LocalMulti.prototype.getInputText = function() {

  var pos = this.getLastTokenPos();

  if (pos == -1) {
    return this.input.value;
  } else {
    return this.input.value.substr(pos + 1);
  }
};

Suggest.LocalMulti.prototype.setInputText = function(text) {

  var pos = this.getLastTokenPos();

  if (pos == -1) {
    this.input.value = text;
  } else {
    this.input.value = this.input.value.substr(0 , pos + 1) + text;
  }
};

Suggest.LocalMulti.prototype.getLastTokenPos = function() {
  return this.input.value.lastIndexOf(this.delim);
};
};

start();
